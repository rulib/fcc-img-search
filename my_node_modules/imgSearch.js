var imgur = require('../private/secret.js');
var request = require('request');

exports.imgLoad = function (req, res, next){
    var query = req.params.search;
    var page = req.query.offset;
    var clientId = imgur.clientId;
    var searchUrl = 'https://api.imgur.com/3/gallery/search/time/'+page+'?q='+query;
    var options = {
        url:searchUrl,
        headers:{
            "Authorization":"Client-ID "+clientId
        }
    };
    function callback(error, response, body) {
        if (!error && response.statusCode == 200) {
            var info = JSON.parse(body);
            req.imgurRaw = info;
            //res.json(info.data);
            req.db.collection("searches").insert({
                search:query,
                time: Date.now()
            });
            next();
        }
    }
    request (options, callback);
    };
    
exports.recentSearches = function(req,res,next){
    req.db.collection("searches").find().sort({time:-1}).limit(10).toArray(
        function (err, result){
            if (err) {console.log("Database search toArray error")}
            else {res.jsonp(result)}
        });
};
    
exports.searchProcess = function(req,res,next){
    var searchJSON = req.imgurRaw.data;
    var outputJSON = [];
    for (var i = 0; i < searchJSON.length;i++){
        var stripped = objStrip(searchJSON[i]);
        if (stripped.title){
        outputJSON.push(stripped);}
    }
    res.jsonp({Results:outputJSON});
};

var objStrip = function(searchObj){
    var outputObj = {};
    if (searchObj.is_album===false && searchObj.gifv === undefined){
        var linkArray = searchObj.link.split(".");
        outputObj = {
             link : searchObj.link
            ,title : searchObj.title
            ,thumbnail : linkArray[0] + "." + linkArray[1] +"." + linkArray[2] + "b." + linkArray[3]
            ,is_album : false
            };
    }
    else if (searchObj.gifv === undefined){
        outputObj = {
            link : searchObj.link
            ,title : searchObj.title
            ,thumbnail : "http://i.imgur.com/" + searchObj.cover + "b.jpg"
            ,is_album : true
            };
    }
    return outputObj;
    
};